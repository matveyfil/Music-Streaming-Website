user nginx;
worker_processes auto;

error_log /var/log/nginx/error.log warn;
pid /var/run/nginx.pid;

events {
    worker_connections 1024;
}

http {
    include /etc/nginx/mime.types;

    # JSON access log -> stdout
    log_format json_combined escape=json
      '{ "time":"$time_iso8601",'
      ' "remote_addr":"$remote_addr",'
      ' "request":"$request",'
      ' "status":$status,'
      ' "body_bytes_sent":$body_bytes_sent,'
      ' "referer":"$http_referer",'
      ' "user_agent":"$http_user_agent",'
      ' "request_time":$request_time,'
      ' "upstream":"$upstream_addr",'
      ' "upstream_time":"$upstream_response_time",'
      ' "host":"$host" }';

    access_log /dev/stdout json_combined;
    error_log  /dev/stderr warn;

    # Proxy timeouts
    proxy_read_timeout 60s;
    proxy_connect_timeout 5s;
    proxy_send_timeout 60s;

    server {
        listen 80;
        server_name localhost;

        client_max_body_size 100M;

        # Home
        location /home {
            proxy_pass http://home-page-container:5000;
        }
        location /images {
            proxy_pass http://home-page-container:5000/images;
        }

        # Auth
        location /login {
            proxy_pass http://register-login-container:5000/login;
        }
        location /register {
            proxy_pass http://register-login-container:5000/register;
        }
        location /logout {
            proxy_pass http://register-login-container:5000/logout;
        }

        # Catalog
        location /catalog {
            proxy_pass http://catalog-container:5000/catalog;
        }
        location ~ ^/song/(?<song_id>.+)$ {
            proxy_pass http://catalog-container:5000/song/$song_id;
        }

        # Upload
        location /upload {
            proxy_pass http://upload-song-container:5000/upload;
        }
        location /static/songs {
            proxy_pass http://upload-song-container:5000/static/songs;
        }

        # History
        location /history {
            proxy_pass http://songs-history-container:5000/history;
        }

        # Kibana
        location /kibana/ {
            proxy_set_header Host $host;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            rewrite ^/kibana/(.*)$ /$1 break;
            proxy_pass http://kibana:5601;
        }

        error_page 500 502 503 504 /50x.html;
        location = /50x.html {
            root /usr/share/nginx/html;
        }
    }
}
